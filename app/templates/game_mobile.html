<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Sudoku - {{ difficulty }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    {% set size = grid|length %}
    
    body {
      background: linear-gradient(to right, #fffde7, #e0f7fa);
      font-family: 'Segoe UI', sans-serif;
    }

    .sudoku-grid {
      display: grid;
      grid-template-columns: repeat({{ size }}, 1fr);
      max-width: 95vw;
      aspect-ratio: 1 / 1;
      margin: auto;
      border: 4px solid #000;
      gap: 1px;
      background: #000;
      {% if size >= 25 %}
      /* 25x25 : Conteneur scrollable pour mobile */
      max-width: 100vw;
      width: 100vw;
      height: 100vw;
      overflow: auto;
      {% elif size >= 16 %}
      max-width: 98vw;
      {% endif %}
    }

    {% if size >= 25 %}
    /* 25x25 Mobile : PLEIN ÉCRAN avec zoom/scroll */
    body {
      padding: 0 !important;
      margin: 0 !important;
      overflow: hidden;
    }

    h2 {
      font-size: 1.2rem !important;
      margin: 5px 0 !important;
      padding: 5px;
      background: rgba(255,255,255,0.9);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }

    .sudoku-cell {
      background: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      min-width: 25px;
      min-height: 25px;
      font-size: 12px;
      border: 0.5px solid #999;
    }

    .sudoku-cell input {
      width: 100%;
      height: 100%;
      text-align: center;
      border: none;
      font-size: 12px;
      background-color: #e0f7fa;
      padding: 0;
    }

    .fixed {
      font-weight: bold;
      font-size: 12px;
      color: #0277bd;
    }

    /* Container PLEIN ÉCRAN scrollable */
    .sudoku-container {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 120px;
      overflow: auto;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f8f8f8;
      padding: 10px;
    }

    .sudoku-grid {
      min-width: 650px;
      min-height: 650px;
      width: 650px;
      height: 650px;
      border: 3px solid #000;
      gap: 0.5px;
    }

    /* Boutons en bas de page fixes */
    .button-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 10px;
      border-top: 2px solid #ddd;
      z-index: 100;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }

    .btn-mobile {
      font-size: 0.9rem !important;
      padding: 8px 12px !important;
      flex: 1;
      min-width: 80px;
      max-width: 120px;
    }

    {% elif size >= 16 %}
    /* 16x16 Mobile : Cellules moyennes */
    .sudoku-cell {
      background: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      min-width: 20px;
      min-height: 20px;
      font-size: 12px;
    }

    .sudoku-cell input {
      width: 100%;
      height: 100%;
      text-align: center;
      border: none;
      font-size: 12px;
      background-color: #e0f7fa;
    }

    .fixed {
      font-weight: bold;
      font-size: 12px;
      color: #0277bd;
    }

    {% else %}
    /* 4x4 et 9x9 Mobile : Cellules standards */
    .sudoku-cell {
      background: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      aspect-ratio: 1 / 1;
    }

    .sudoku-cell input {
      width: 100%;
      height: 100%;
      text-align: center;
      border: none;
      font-size: 1.5em;
      background-color: #e0f7fa;
    }

    .fixed {
      font-weight: bold;
      font-size: 1.5em;
      color: #0277bd;
    }
    {% endif %}

    .sudoku-cell input:focus {
      outline: none;
      background-color: #b2ebf2;
    }

    .top-block    { border-top:    2px solid #000; }
    .left-block   { border-left:   2px solid #000; }
    .bottom-block { border-bottom: 2px solid #000; }
    .right-block  { border-right:  2px solid #000; }

    #loading {
      font-weight: bold;
      color: #0277bd;
      margin-top: 1rem;
      display: none;
    }

    .btn-lg {
      {% if size >= 25 %}
      /* Pas de btn-lg pour 25x25, on utilise btn-mobile */
      display: none;
      {% else %}
      font-size: 1.5rem;
      padding: 1.2rem 1.5rem;
      {% endif %}
    }

    @media print {
      .no-print, .no-print * {
        display: none !important;
      }
    }
  </style>
</head>
<body class="p-4 text-center">
  <h2 class="mb-4">🧩 Sudoku - Niveau {{ difficulty|capitalize }}</h2>

  {% if size >= 25 %}
  <!-- Interface PLEIN ÉCRAN pour 25x25 -->
  <h2>🧩 Sudoku 25x25 - {{ difficulty|capitalize }}</h2>
  
  <div class="sudoku-container">
    <div class="sudoku-grid">
      {% set block_size = (size ** 0.5)|round|int %}
      {% for r in range(size) %}
        {% for c in range(size) %}
          {% set val = grid[r][c] %}
          <div class="sudoku-cell
            {% if r % block_size == 0 %}top-block{% endif %}
            {% if c % block_size == 0 %}left-block{% endif %}
            {% if r == size - 1 %}bottom-block{% endif %}
            {% if c == size - 1 %}right-block{% endif %}">
            {% if val == 0 %}
              <input type="text" maxlength="1" pattern="[0-9A-Za-z]">
            {% else %}
              <span class="fixed">{{ to_symbol(val) }}</span>
            {% endif %}
          </div>
        {% endfor %}
      {% endfor %}
    </div>
  </div>

  <!-- Boutons fixes en bas -->
  <div class="button-container">
    <button onclick="checkSolution()" class="btn btn-success btn-mobile">✅ Vérif</button>
    <button onclick="showSolution()" class="btn btn-info btn-mobile">🧠 Solution</button>
    <button onclick="clearGrid()" class="btn btn-secondary btn-mobile">🧹 Effacer</button>
    <a href="/" class="btn btn-danger btn-mobile">🔄 Nouveau</a>
  </div>

  {% else %}
  <h2 class="mb-4">🧩 Sudoku - Niveau {{ difficulty|capitalize }}</h2>
  
  <!-- Grilles normales 4x4, 9x9, 16x16 -->
  <div class="sudoku-grid">
    {% set block_size = (size ** 0.5)|round|int %}
    {% for r in range(size) %}
      {% for c in range(size) %}
        {% set val = grid[r][c] %}
        <div class="sudoku-cell
          {% if r % block_size == 0 %}top-block{% endif %}
          {% if c % block_size == 0 %}left-block{% endif %}
          {% if r == size - 1 %}bottom-block{% endif %}
          {% if c == size - 1 %}right-block{% endif %}">
          {% if val == 0 %}
            <input type="text" maxlength="1" pattern="[0-9A-Za-z]">
          {% else %}
            <span class="fixed">{{ to_symbol(val) }}</span>
          {% endif %}
        </div>
      {% endfor %}
    {% endfor %}
  </div>

  <div id="loading">⏳ Calcul de la solution en cours...</div>

  <div class="no-print mt-4 d-flex justify-content-center flex-wrap gap-3">
    <button onclick="checkSolution()" class="btn btn-success btn-lg">✅ Vérifier</button>
    <button onclick="checkIfComplete()" class="btn btn-warning btn-lg">🔍 Complète ?</button>
    <button onclick="showSolution()" class="btn btn-info btn-lg">🧠 Solution</button>
    <button onclick="clearGrid()" class="btn btn-secondary btn-lg">🧹 Effacer</button>
    <a href="/" class="btn btn-danger btn-lg">🔄 Recommencer</a>
  </div>
  {% endif %}

  <footer class="mt-5 text-muted">© 2025 Frédéric SALERNO. Tous droits réservés.</footer>
<script>
  const GRID_SIZE = {{ size }};

  function toSymbol(n) {
    return n <= 9 ? n.toString() : String.fromCharCode(55 + n);
  }

  function extractGrid() {
    const cells = document.querySelectorAll(".sudoku-cell");
    const size = Math.sqrt(cells.length);
    const grid = [];

    for (let r = 0; r < size; r++) {
      const row = [];
      for (let c = 0; c < size; c++) {
        const cell = cells[r * size + c];
        const input = cell.querySelector("input");
        let val = 0;
        if (input && input.value.trim()) {
          const raw = input.value.trim().toUpperCase();
          val = /[A-Z]/.test(raw) ? raw.charCodeAt(0) - 55 : parseInt(raw);
        } else if (!input) {
          const raw = cell.textContent.trim().toUpperCase();
          val = /[A-Z]/.test(raw) ? raw.charCodeAt(0) - 55 : parseInt(raw);
        }
        row.push(isNaN(val) ? 0 : val);
      }
      grid.push(row);
    }

    return grid;
  }

  async function checkSolution() {
    const grid = extractGrid();
    const response = await fetch('/check', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({grid})
    });
    const result = await response.json();
    alert(result.correct ? "✅ La grille est correcte !" : "❌ La grille contient des erreurs !");
  }

  function checkIfComplete() {
    const grid = extractGrid();
    for (const row of grid) {
      if (row.includes(0)) {
        alert("⚠️ Il manque encore des cases !");
        return;
      }
    }
    alert("✅ La grille est entièrement remplie !");
  }

  async function showSolution() {
    const loading = document.getElementById("loading");
    loading.style.display = "block";

    try {
      const response = await fetch('/solution');
      const result = await response.json();
      const solved = result.solution;

      const cells = document.querySelectorAll(".sudoku-cell");
      let i = 0;
      for (let r = 0; r < solved.length; r++) {
        for (let c = 0; c < solved.length; c++) {
          const input = cells[i].querySelector("input");
          if (input) input.value = toSymbol(solved[r][c]);
          i++;
        }
      }
    } catch (e) {
      alert("Erreur lors de la récupération de la solution !");
    } finally {
      loading.style.display = "none";
    }
  }

  function clearGrid() {
    document.querySelectorAll(".sudoku-cell input").forEach(el => el.value = "");
  }
</script>
</body>
</html>